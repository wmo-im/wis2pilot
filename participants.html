<!DOCTYPE html>
<html>
    <head>
         <meta charset="UTF-8">
        <title>WIS2 pilot participants</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    </head>

    <body>
        <header>
            <h2>WIS2 pilot participants (<a href="https://github.com/wmo-im/wis2pilot/blob/main/participants.csv">GitHub</a>)</h2>
        </header>
        <hr>
        <section id="main">
            <form>
                <input type="radio" id="up" name="display_type" value="up" onclick="redrawLayer();" checked>
                <label for="live">Live services</label><br>
                <input type="radio" id="global" name="display_type" value="global" onclick="redrawLayer();">
                <label for="global">Global services</label><br>
                <input type="radio" id="all" name="display_type" value="all" onclick="redrawLayer();">
                <label for="all">All services</label><br>
            </form>
            <div id="map" style="width: 1000px; height: 1000px;"></div>
        </section>
        <hr>
        <footer>Powered by WIS 2.0</footer>
    </body>

    <script>
        var geojsonData = null;
        var geojsonLayer = null;
        var map = L.map('map').setView([0, 0], 2);
        var tiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attributionControl: false
        }).addTo(map);
        map.attributionControl.setPrefix('');

        function redrawLayer(displayType) {
            map.removeLayer(geojsonLayer);
            addTheLayer(geojsonData);
        }

        function genPopup(feature, layer) {
            var popupText = feature.properties.Country + ' (' + feature.properties.City + ') - ' + feature.properties.Component;
            layer.bindPopup(popupText);
        }

        function genMarker(feature, latlng) {
            var displayType = 'all';

            element = document.getElementsByName('display_type');

            for (var i = 0, length = element.length; i < length; i++) {
                if (element[i].checked) {
                    displayType = element[i].value;                    
                }
            }

            if (displayType === 'up' && feature.properties.Status !== 'Up') {
                return;
            }
            else if (displayType === 'global' && feature.properties.Component.includes('Global') === false) {
                return;
            }

            var icon = new L.Icon({
                iconUrl: feature.properties.markerIcon,
                iconSize: [32, 32]
            });
            return L.marker(latlng, {icon: icon});
        }

        fetch('participants.geojson').then(function(response) {
            return response.json();
        }).then(function(data) {
            geojsonData = data;
            addTheLayer(geojsonData);
        });

        function addTheLayer(data) {
            geojsonLayer = L.geoJSON(data, {
                pointToLayer: genMarker,
                onEachFeature: genPopup
            })
            geojsonLayer.addTo(map);
//            map.fitWorld();
        }
    </script>
</html>
